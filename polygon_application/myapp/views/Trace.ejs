<!DOCTYPE html>
<script
src="https://code.jquery.com/jquery-3.6.0.min.js"
integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.7.2/dist/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-piechart-outlabels "></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@1.5.3/dist/web3.min.js"></script>
<style>
  .accordion-button:hover{
    background-color: rgba(151, 215, 109, 0.334);
  }
  .invisible_block{
    display: none;
  }
  .table{
    text-align: center;
  }
</style>
<html>
  <head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <% include menu.ejs %>
    <div class="CompanyId-page">
      <div class="accordion" id="accordionExample">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" id="CompanyId_page_button" type="button" data-bs-toggle="collapse" data-bs-target="#CompanyId_page" aria-expanded="true" aria-controls="collapseOne">
                Company ID 追蹤碳權資訊
              </button>
            </h2>
            <div id="CompanyId_page" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
              <div class="accordion-body">
                <div class="CompanyId">
                  <p>CompanyId ID:<input type="text" id="companyId" placeholder="e.g. 0000"/></p>
                  <button id="button_CompanyId" class="btn btn-outline-primary">搜尋</button>
                  <p id="CompanyId_name_status"></p>
                  <p id="CompanyId_used_status"></p>
                  <p id="CompanyId_retire_status"></p>
                  <span id="CompanyID_search_details" class="invisible_block">
                    <span style="display: flex; justify-content: center;"><strong style="font-size: 20px;">碳權抵消細項</strong></span>
                    <span style="display: flex; justify-content: center;"><strong id="Company_noData" class="invisible_block">No Data</strong><table id="show_table_Company" class="table table-striped table-hover invisible_block">
                    </table></span>
                  </span>
                </div>
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" id="nft_page_button"  type="button" data-bs-toggle="collapse" data-bs-target="#nft_page" aria-expanded="false" aria-controls="collapseThree">
                  NFT ID 追蹤碳權資訊
              </button>
            </h2>
            <div id="nft_page" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
              <div class="accordion-body">
                <div class="nft">
                  <p>NFT ID:<input type="text" id="nftId" placeholder="e.g. 1"/></p>
                  <button id="button_nft" class="btn btn-outline-primary">搜尋</button>
                  <p id="nft_status"></p>
                  <span id="NFTID_search_details" class="invisible_block">
                    <span style="display: flex; justify-content: center;"><strong style="font-size: 20px;">碳權NFT資訊</strong></span>
                    <span style="display: flex; justify-content: center;"><strong id="NFT_noData" class="invisible_block">No Data</strong><table id="show_table_NFT" class="table table-striped table-hover invisible_block">
                    </table></span>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
    <script>
      window.addEventListener('load', function() {
        var currentURL = window.location.href;
        switch(currentURL){
          case 'http://140.116.234.100:1314/trace':
            break;
          case 'http://140.116.234.100:1314/trace/companyId':
            $("#CompanyId_page_button").removeClass("collapsed");
            $("#CompanyId_page").addClass("show");
            break;
          case 'http://140.116.234.100:1314/trace/nft':
            $("#nft_page_button").removeClass("collapsed");
            $("#nft_page").addClass("show");
            //$("#retireCompany_page_button").click();
            break;
        }
      });
    </script>
    <script>
      const button_nft = document.getElementById("button_nft");
      const button_companyId = document.getElementById("button_CompanyId");
      button_nft.addEventListener('click', async() => {
        const nftId = document.getElementById("nftId").value;
        button_nft.disabled=true;
        await $.ajax({
                  type: "GET",
                  url: "/trace/getSingleNFTInfo",
                  data: {
                    tokenId: nftId
                  },               
                  success: function (data) {
                    catch_nftInfo(data);
                  },
                  error: function (err) {
                  }            
              });
            function catch_nftInfo(result){
                showTable_NFT(result);
                $("#NFTID_search_details").removeClass("invisible_block");
                button_nft.disabled=false;
            }
          });
      button_companyId.addEventListener('click', async() => {
        const companyId = document.getElementById("companyId").value;
        button_companyId.disabled=true;
        await $.ajax({
                  type: "GET",
                  url: "/trace/getSingleCompanyInfo",
                  data: {
                    Id: companyId
                  },               
                  success: function (data) {
                    catch_companyInfo(data);
                  },
                  error: function (err) {
                  }            
              });
            async function catch_companyInfo(data){
                document.getElementById("CompanyId_name_status").innerHTML='公司名:'+data[0][0];
                document.getElementById("CompanyId_used_status").innerHTML='申請的碳權 NFT 編號:'+data[1][1];
                document.getElementById("CompanyId_retire_status").innerHTML='碳權申請總量:'+data[1][0]+
                `<span style="margin-right:10px;"></span>`+
                ' 碳排抵消次數:'+data[2][3]+
                `<span style="margin-right:10px;"></span>`+
                ' 碳排抵消總量:'+data[2][2];
                await $.ajax({
                  type: "GET",
                  url: "/trace/getSingleCertificate",
                  data: {
                    Id :data[3]
                  },               
                  success: function (data) {
                    catch_certificateInfo(data);
                  },
                  error: function (err) {
                  }            
                });
                function catch_certificateInfo(result){
                  showTable_Company(result);
                  $("#CompanyID_search_details").removeClass("invisible_block");
                  button_companyId.disabled=false;
                }
              }
      });
    </script>
    <script>
      async function showTable_Company(data){
        if(data==false){
          $("#Company_noData").removeClass("invisible_block");
          $("#show_table_Company").addClass("invisible_block");
        }
        else{
          $("#Company_noData").addClass("invisible_block");
          $("#show_table_Company").removeClass("invisible_block");
        var ul = document.getElementById('show_table_Company');
        var total_data="";
        var count = 0;
        var tableHead=initialTable_Company();
        total_data+=tableHead;
        total_data+='<tbody class="table-group-divider" style="font-size:12px;">';
        total_data+=await addTable_Company(data);
        total_data+='</tbody>';
        ul.innerHTML = total_data;
        }
        }
        function addTable_Company(data){
          var table='';
          for(var i =0;i<data[1].length;i++){
          table+='<tr style="font-size:16px;">';
          table+='<td>'+data[1][i]+"</td>";
          table+='<td>'+data[0][i].CompanyId+"</td>";
          table+='<td>'+data[0][i].CompanyName+"</td>";
          table+='<td>'+data[0][i][3]+"</td>";
          var newcase=String(data[0][i].status);
          switch(newcase){
          case '0':
            table+='<td>'+'NFT(GiM-CNFT)'+"</td>";
            break;
          case '1':
            table+='<td>'+'Token(GiM-CT)'+"</td>";
            break;
          default:
            table+='<td>'+'NULL'+"</td>";
            break;
          }
          table+="</tr>";
          }
          return table;
          }
        function initialTable_Company(){
          var head='';
          head+='<thead style="height: 4%;font-size: 16px;">';
          head+='<tr>';
          head+='<th scope="col">Retirement ID</th>';
          head+='<th scope="col">Company ID</th>';
          head+='<th scope="col">Company Name </th>';
          head+='<th scope="col">Carbon Amount</th>';
          head+='<th scope="col">Retired Method</th>';
          head+='</tr>';
          head+='</thead>';
          return head;
          }
    </script>
        <script>
          async function showTable_NFT(data){
            if(data==false){
              $("#NFT_noData").removeClass("invisible_block");
              $("#show_table_NFT").addClass("invisible_block");
            }
            else{
              $("#NFT_noData").addClass("invisible_block");
              $("#show_table_NFT").removeClass("invisible_block");
              var ul = document.getElementById('show_table_NFT');
            var total_data="";
            var count = 0;
            var tableHead=initialTable_NFT();
            total_data+=tableHead;
            total_data+='<tbody class="table-group-divider" style="font-size:12px;">';
            total_data+=await addTable_NFT(data);
            total_data+='</tbody>';
            ul.innerHTML = total_data;
            }
            }
            function addTable_NFT(data){
              var table='';
              table+='<tr style="font-size:16px;">';
              table+='<td>'+data[0].CompanyId+"</td>";
              table+='<td>'+data[0].CompanyName+"</td>";
              table+='<td>'+data[0].carbonAmount+"</td>";
              var newcase=String(data[0].status);
              switch(newcase){
                case '0':
                  table+='<td>'+'Not Verified'+"</td>";
                  break;
                case '1':
                  table+='<td>'+'Verified'+"</td>";
                  break;
                case '2':
                  table+='<td>'+'Fractionalized'+"</td>";
                  break;
                case '3':
                  table+='<td>'+'Retired'+"</td>";
                  break;
                default:
                  table+='<td>'+'NULL'+"</td>";
                  break;
              }
              table+='<td>'+data[1]+"</td>";
              table+="</tr>";
              return table;
              }
            function initialTable_NFT(){
              var head='';
              head+='<thead style="height: 4%;font-size: 16px;">';
              head+='<tr>';
              head+='<th scope="col">Company ID</th>';
              head+='<th scope="col">Company Name </th>';
              head+='<th scope="col">Carbon Amount</th>';
              head+='<th scope="col">NFT Status</th>';
              head+='<th scope="col">Owner</th>';
              head+='</tr>';
              head+='</thead>';
              return head;
              }
        </script>
  </body>
</html>